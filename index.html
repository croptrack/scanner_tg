<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skaner 3000</title>
    <script src="telegram.org"></script>
    <script src="cdn.jsdelivr.net"></script>
    <script src="cdn.jsdelivr.net"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; color: #0f0; font-family: monospace; }
        #container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: #000; }
        #ui-overlay { position: relative; z-index: 10; width: 100%; text-align: center; margin-top: 20px; }
        .status { background: rgba(0,0,0,0.8); padding: 8px; margin: 10px auto; width: 80%; border: 1px solid #0f0; font-size: 14px; min-height: 20px; }
        #result { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 15px #000; 
            display: none; padding: 25px; border-radius: 15px; z-index: 100; 
            text-align: center; width: 85%; border: 4px solid; background: rgba(0,0,0,0.9);
        }
        .btn-box { position: relative; display: inline-block; margin-top: 10px; }
        #startButton { background: #0f0; color: #000; border: none; padding: 15px 30px; font-size: 1.1rem; font-weight: bold; border-radius: 8px; }
        #fileInput { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; }
    </style>
</head>
<body>

<div id="container">
    <canvas id="output"></canvas>
    <div id="ui-overlay">
        <div class="status" id="statusBox">ЗАГРУЗКА СИСТЕМЫ...</div>
        <div class="btn-box">
            <button id="startButton">СДЕЛАТЬ СКАН</button>
            <input type="file" accept="image/*" capture="user" id="fileInput">
        </div>
    </div>
    <div id="result"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const statusBox = document.getElementById('statusBox');
    const resultDiv = document.getElementById('result');
    const fileInput = document.getElementById('fileInput');

    let detector;

    // Инициализация нейросети
    async function init() {
        try {
            const model = faceDetection.SupportedModels.MediaPipeFaceDetector;
            detector = await faceDetection.createDetector(model, { runtime: 'tfjs' });
            statusBox.innerText = "СИСТЕМА ГОТОВА. ЖДУ ФОТО.";
        } catch (e) {
            statusBox.innerText = "ОШИБКА ЗАГРУЗКИ";
        }
    }

    fileInput.onchange = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        statusBox.innerText = "АНАЛИЗ... ПОДОЖДИТЕ";
        resultDiv.style.display = 'none';

        const img = new Image();
        img.src = URL.createObjectURL(file);

        img.onload = async () => {
            // Подгоняем холст
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            try {
                const faces = await detector.estimateFaces(img);
                
                if (faces && faces.length > 0) {
                    statusBox.innerText = "ОБЪЕКТ ИДЕНТИФИЦИРОВАН";
                    
                    // Рисуем рамку
                    ctx.strokeStyle = "#0f0";
                    ctx.lineWidth = Math.round(img.width / 50);
                    faces.forEach(f => {
                        ctx.strokeRect(f.box.xMin, f.box.yMin, f.box.width, f.box.height);
                    });

                    // Показываем вердикт через небольшую паузу
                    setTimeout(showVerdict, 800);
                } else {
                    statusBox.innerText = "ЛИЦО НЕ НАЙДЕНО. ПОВТОРИТЕ.";
                }
            } catch (err) {
                statusBox.innerText = "СБОЙ СКАНЕРА";
            }
        };
    };

    function showVerdict() {
        const isBad = Math.random() > 0.5;
        resultDiv.innerText = isBad ? 'ДАЛБАЁБ' : 'НЕ ДАЛБАЁБ';
        resultDiv.style.color = isBad ? '#ff0000' : '#00ff00';
        resultDiv.style.borderColor = isBad ? '#ff0000' : '#00ff00';
        resultDiv.style.display = 'block';
        
        statusBox.innerText = "СКАНИРОВАНИЕ ЗАВЕРШЕНО";
        
        // Вибрация телефона (если поддерживается)
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(isBad ? 'error' : 'success');
    }

    init();
</script>
</body>
</html>
