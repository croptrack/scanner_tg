<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Object Scanner</title>
    <!-- Подключаем библиотеки ИИ -->
    <script src="cdn.jsdelivr.net"></script>
    <script src="cdn.jsdelivr.net"></script>
    <script src="telegram.org"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: -apple-system, sans-serif; color: white; }
        #container { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; display: none; }

        /* Начальный экран для разблокировки камеры */
        #startScreen { position: absolute; z-index: 100; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-start { background: #00ff00; color: #000; padding: 20px 50px; border: none; border-radius: 15px; font-size: 1.6rem; font-weight: bold; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 20px rgba(0,255,0,0.4); }

        /* Кнопка ФОТО (появляется только при детекте) */
        #shutter {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%) scale(0);
            width: 85px; height: 85px; background: rgba(255,255,255,0.3);
            border: 6px solid #fff; border-radius: 50%; z-index: 20;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; justify-content: center; align-items: center;
        }
        #shutter::after { content: ''; width: 65px; height: 65px; background: #fff; border-radius: 50%; }
        #shutter.visible { transform: translateX(-50%) scale(1); }

        /* Плашка статуса ИИ */
        #status { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 25px; font-size: 14px; color: #0f0; z-index: 30; pointer-events: none; border: 1px solid #0f0; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="container">
    <!-- Кнопка ПОГНАЛИ обязательна для Safari/Chrome/Telegram -->
    <div id="startScreen">
        <button class="btn-start" onclick="initApp()">ПОГНАЛИ</button>
        <p style="color: #888; margin-top: 20px;">Нажми для старта сканера</p>
    </div>

    <div id="status" style="display:none">ЗАГРУЗКА ИИ...</div>
    
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="photoCanvas"></canvas>
    
    <div id="shutter" onclick="takePhoto()"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const video = document.getElementById('webcam');
    const canvas = document.getElementById('photoCanvas');
    const shutter = document.getElementById('shutter');
    const status = document.getElementById('status');
    const startScreen = document.getElementById('startScreen');
    
    let model = null;

    // 1. Инициализация по клику (требование безопасности браузеров 2025)
    async function initApp() {
        startScreen.style.display = 'none';
        status.style.display = 'block';
        
        try {
            // Запрашиваем камеру (заднюю)
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
                audio: false
            });
            video.srcObject = stream;
            
            // Принудительный старт видео для iOS/Telegram
            video.onloadedmetadata = () => { video.play(); };

            // Загружаем легкую нейронку COCO-SSD
            model = await cocoSsd.load();
            status.innerText = "СКАНЕР АКТИВЕН";
            runDetection();
        } catch (err) {
            status.style.color = "red";
            status.innerText = "ОШИБКА: НУЖЕН HTTPS И ДОСТУП";
            console.error(err);
        }
    }

    // 2. Цикл ИИ детекции
    async function runDetection() {
        if (!model || video.paused) return;

        try {
            const predictions = await model.detect(video);
            
            // Если ИИ нашел любой объект (человек, телефон, кошка и т.д.) с уверенностью > 60%
            const foundObject = predictions.find(p => p.score > 0.60);

            if (foundObject) {
                status.innerText = "ОБЪЕКТ: " + foundObject.class.toUpperCase();
                shutter.classList.add('visible');
            } else {
                status.innerText = "ПОИСК ОБЪЕКТОВ...";
                shutter.classList.remove('visible');
            }
        } catch (e) {
            console.log("Детекция пропущена");
        }

        requestAnimationFrame(runDetection);
    }

    // 3. Сохранение фото
    function takePhoto() {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        // Замораживаем картинку
        canvas.style.display = 'block';
        shutter.classList.remove('visible');
        status.innerText = "СНИМОК ГОТОВ";

        // Вибрация через SDK Telegram
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        
        // Показываем кнопку "ЗАНОВО" в интерфейсе Телеграм
        tg.MainButton.setText("СДЕЛАТЬ ЕЩЕ").show().onClick(() => {
            location.reload();
        });
    }
</script>
</body>
</html>
